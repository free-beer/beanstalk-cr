<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.35.1">
<meta name="crystal_docs.project_version" content="HEAD-dev">
<meta name="crystal_docs.project_name" content="beanstalk-cr">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="beanstalk-cr">
  <title>beanstalk-cr HEAD-dev</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          beanstalk-cr
        </a>
      </h1>

      <span class="project-version">
        HEAD-dev
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="beanstalk-cr/Beanstalk" data-name="beanstalk">
      <a href="Beanstalk.html">Beanstalk</a>
      
        <ul>
  
  <li class=" " data-id="beanstalk-cr/Beanstalk/Connection" data-name="beanstalk::connection">
      <a href="Beanstalk/Connection.html">Connection</a>
      
    </li>
  
  <li class=" " data-id="beanstalk-cr/Beanstalk/Exception" data-name="beanstalk::exception">
      <a href="Beanstalk/Exception.html">Exception</a>
      
    </li>
  
  <li class="parent " data-id="beanstalk-cr/Beanstalk/Job" data-name="beanstalk::job">
      <a href="Beanstalk/Job.html">Job</a>
      
        <ul>
  
  <li class=" " data-id="beanstalk-cr/Beanstalk/Job/Settings" data-name="beanstalk::job::settings">
      <a href="Beanstalk/Job/Settings.html">Settings</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="beanstalk-cr/Beanstalk/Server" data-name="beanstalk::server">
      <a href="Beanstalk/Server.html">Server</a>
      
    </li>
  
  <li class="parent " data-id="beanstalk-cr/Beanstalk/Tube" data-name="beanstalk::tube">
      <a href="Beanstalk/Tube.html">Tube</a>
      
        <ul>
  
  <li class=" " data-id="beanstalk-cr/Beanstalk/Tube/JobState" data-name="beanstalk::tube::jobstate">
      <a href="Beanstalk/Tube/JobState.html">JobState</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="beanstalk-cr" class="anchor" href="#beanstalk-cr">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>beanstalk-cr</h1>

<p>A Crystal library for interfacing with the Beanstalk queue.</p>

<p><a href="https://github.com/free-beer/beanstalk-cr/releases"><img src="https://img.shields.io/github/v/release/free-beer/beanstalk-cr?include_prereleases" alt="GitHub release"/></a></p>

<p><a href="https://travis-ci.org/free-beer/beanstalk-cr"><img src="https://travis-ci.org/free-beer/beanstalk-cr.svg?branch=master" alt="Build Status"/></a></p>

<p><a href="https://free-beer.github.io/beanstalk-cr/"><img src="https://img.shields.io/badge/docs-available-brightgreen.svg" alt="Docs"/></a></p>

<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>

<ol><li>Add the dependency to your <code>shard.yml</code>:</li></ol>

<p><code></code>`yaml
   dependencies:</p>

<pre><code class="language-crystal"> beanstalk-cr:
   github: free-beer/beanstalk-cr</code></pre>

<p><code></code>`</p>

<ol><li>Run <code>shards install</code></li></ol>

<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;beanstalk-cr&quot;</span></code></pre>

<p>All code for the library is contained within a module called <code></code><code><a href="Beanstalk.html">Beanstalk</a></code><code></code>.
To connect to a Beanstalk server instance you can call the <code></code><code>open()</code><code></code> method
on the <code></code><code><a href="Beanstalk/Connection.html">Beanstalk::Connection</a></code><code></code> class like this...</p>

<pre><code class="language-crystal">  connection <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Connection</span>.open()</code></pre>

<p>This will attempt to connect to a server running on <code></code><code>localhost</code><code></code> at the
default Beanstalk port number (11300). If you want to change the server that
gets connected to you can specify that in the call to <code></code><code>open()</code><code></code> like
this...</p>

<pre><code class="language-crystal">  connection <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Connection</span>.open(<span class="s">&quot;my.host.name&quot;</span>, <span class="n">12345</span>)</code></pre>

<p>Once you have a connection to a Beanstalk instance you can use it to obtain a
<code></code><code>Tube</code><code></code> instance. Tubes are used by Beanstalk as a primary interaction
interface. There are two primary mechanisms for obtaining a <code></code><code>Tube</code><code></code> from a
<code></code><code>Connection</code><code></code> and these are shown below...</p>

<pre><code class="language-crystal">  tube1 <span class="o">=</span> connection.default_tube
  tube2 <span class="o">=</span> connection[<span class="s">&quot;my_q&quot;</span>]</code></pre>

<p>The differences between these requires an explanation of the Beanstalk concepts
of 'using' and 'watching'. These concepts refer to actual queues on the Beanstalk
server and how your <code></code><code>Tube</code><code></code> instance interacts with them. The queue that a
<code></code><code>Tube</code><code></code> is using will be the queue that it inserts content into. A <code></code><code>Tube</code><code></code>
can only be 'using' a single queue. On the other hand, a <code></code><code>Tube</code><code></code> can be
<code>watching</code> multiple queues and these are the queues that the <code></code><code>Tube</code><code></code> will
check when it's looking to receive content.</p>

<p>In the code above, using <code></code><code>connection.default_tube</code><code></code> will retrieve a <code></code><code>Tube</code><code></code>
instance that is using and watching only the default queues (i.e. the queue
with the name 'default'). Using <code></code><code>connection["my_q"]</code><code></code> will retrieve a
<code></code><code>Tube</code><code></code> that is using and watching a queue called "my_q". Note, that if a
queue does not exist when you request to use or watch it, Beanstalk will
automatically create it.</p>

<p>The queues that a <code></code><code>Tube</code><code></code> instance is using or watching can be changed after
the <code></code><code>Tube</code><code></code> instance has been obtained using calls like...</p>

<pre><code class="language-crystal">  tube.use <span class="s">&quot;other_q&quot;</span>
  tube.watch <span class="s">&quot;a_third_q&quot;</span></code></pre>

<h3><a id="jobs" class="anchor" href="#jobs">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Jobs</h3>

<p>Beanstalk refers to the content of it's queues as jobs. In general terms a job
is a collection of data that has been inserted into a queue or can be retrieved
from a queue. This is modelled in the library with the <code></code><code>Job</code><code></code> class. To create
a new <code></code><code>Job</code><code></code> you can simply construct it. Once constructed you can add data to
the <code></code><code>Job</code><code></code> instance. The code below shows some examples of this...</p>

<pre><code class="language-crystal">  <span class="c"># Create an empty job.</span>
  job1 <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>.<span class="k">new</span>

  <span class="c"># Create a job populated with data from a String.</span>
  job2 <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>.<span class="k">new</span>(<span class="s">&quot;The data content for the job.&quot;</span>)

  <span class="c"># Create a job from an Array(UInt8).</span>
  array <span class="o">=</span> [<span class="n">1_u8</span>, <span class="n">2_u8</span>, <span class="n">3_u8</span>, <span class="n">4_u8</span>, <span class="n">5_u8</span>]
  job3  <span class="o">=</span> <span class="k">new</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>(array)

  <span class="c"># Create a job from a Slice(UInt8)</span>
  slice <span class="o">=</span> <span class="t">Slice</span>.<span class="k">new</span>(array.to_unsafe, array.size)
  job4  <span class="o">=</span> <span class="k">new</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>(slice)

  <span class="c"># Create a job from mixed data sources.</span>
  job5 <span class="o">=</span> <span class="k">new</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>(<span class="s">&quot;Some text.&quot;</span>, array, slice)</code></pre>

<p>Data can be added to an existing <code></code><code>Job</code><code></code> instance by calling one of it's
<code></code><code>append()</code><code></code> methods. You can check the size of a <code></code><code>Job</code><code></code> (i.e. the number of
bytes of data it contains) by calling the <code></code><code>size()</code><code></code> method and fetch the actual
data by calling the <code></code><code>bytes()</code><code></code> method. A call to the <code></code><code>to_s()</code><code></code> method will
attempt to convert the <code></code><code>Job</code><code></code> data to a <code></code><code>String</code><code></code> so don't call this unless
you're sure that data actually does represent a <code></code><code>String</code><code></code>.</p>

<p>Once you have a <code></code><code>Job</code><code></code> you can add it to a Beanstalk queue by calling the
<code></code><code>put()</code><code></code> method on a <code></code><code>Tube</code><code></code> instance. The <code></code><code>Job</code><code></code> will be added to the
queue that the <code></code><code>Tube</code><code></code> is currently set to use. Prior to being added to a
queue a <code></code><code>Job</code><code></code> instance will have a <code></code><code>nil</code><code></code> value for it's <code></code><code>id</code><code></code>
attribute. After being added the <code></code><code>id</code><code></code> will be updated to match the id value
assigned to the <code></code><code>Job</code><code></code> by Beanstalk. Examples of adding jobs to a Beanstalk
queue are shown below...</p>

<pre><code class="language-crystal">  tube <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Connection</span>.open.default_tube

  <span class="c"># Adding a job with default settings for priority, delay and TTR.</span>
  job1 <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>.<span class="k">new</span>(<span class="s">&quot;Some content for my first job.&quot;</span>)
  tube.put(job1)

  <span class="c"># Adding a job with explicit settings for priority, delay and TTR.</span>
  settings <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span><span class="t">::</span><span class="t">Settings</span>.<span class="k">new</span>(<span class="n">0</span>, <span class="n">120</span>, <span class="n">600</span>)
  job2     <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span>.<span class="k">new</span>(<span class="s">&quot;Some different content for my second job.&quot;</span>)
  tube.put(job2, settings)</code></pre>

<p>When adding a <code></code><code>Job</code><code></code> to a queue Beanstalk has three associated concepts called
priority, delay and time to run (TTR). Priority is a mechanism saying something
about the relative importance of different jobs, with lower priority settings being
considered more important and therefore getting delivered sooner. A jobs delay
setting indicates to Beanstalk that it should hold off on making the job available
for retrieval for a specific number of seconds. Finally a jobs TTR indicates how
much time a client has (in seconds) to do something with a job before Beanstalk will
release their hold on the job and make it available for retrieval again.</p>

<p>Another way to obtain a <code></code><code>Job</code><code></code> instance is to retrieve one from the Beanstalk
server. The primary mechanism for doing this is referred to by Beanstalk as
'reserving' the job. When you reserve a job from Beanstalk you are taking
temporary ownership of the job. At some future point it is expected that you
will either delete the job, release ownership of it or 'bury' it. The TTR setting
for a job when it is created indicates how long (in seconds) you have to act on
a job before the Beanstalk server will return it to the population of jobs that
are available to be reserved. Examples of fetching jobs from Beanstalk are shown
below...</p>

<pre><code class="language-crystal">  <span class="c"># Returns immediately with either a Job instance or nil.</span>
  job1 <span class="o">=</span> tube.reserve?

  <span class="c"># Waits a most the specified time span for a job to become available or</span>
  <span class="c"># returns nil if the time expires and a job is not available.</span>
  job2 <span class="o">=</span> tube.reserve(<span class="t">Time</span><span class="t">::</span><span class="t">Span</span>.<span class="k">new</span>(seconds: <span class="n">10</span>))

  <span class="c"># Block until a job becomes available.</span>
  job3 <span class="o">=</span> tube.reserve</code></pre>

<p>Once you have a <code></code><code>Job</code><code></code> instance you can perform whatever associating processing
that you want. Once this is finished you must do something to indicate to the
Beanstalk server that you are finished with the <code></code><code>Job</code><code></code>. To do any of these things
you must have already have reserved the <code></code><code>Job</code><code></code> and the TTR for the <code></code><code>Job</code><code></code> must
not have expired. Examples of what you can do include...</p>

<pre><code class="language-crystal">  <span class="c"># Delete the job from the Beanstalk queue.</span>
  tube.delete(job)

  <span class="c"># Release the job back to Beanstalk so that it can be reserved again.</span>
  tube.release(job)

  <span class="c"># Release the job giving it different priority and delay settings.</span>
  settings <span class="o">=</span> <span class="t">Beanstalk</span><span class="t">::</span><span class="t">Job</span><span class="t">::</span><span class="t">Settings</span>.<span class="k">new</span>(<span class="n">250</span>, <span class="n">600</span>)
  tube.release(job, settings)

  <span class="c"># Touch the job, resetting the TTR for your reservation.</span>
  tube.touch(job)

  <span class="c"># Bury the job (i.e. make it unavailable for reservation until it is &#39;kicked&#39; back</span>
  <span class="c"># into the ready pool).</span>
  tube.bury(job)</code></pre>

<p>This covers the primary usage for the library. There are other capabilities provided
by the library but you should consult the API documentation for further details.</p>

<h3><a id="environment-settings" class="anchor" href="#environment-settings">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Environment Settings</h3>

<p>The library takes note of a number of enviroment settings that can alter how it operates
when these are set. These are detailed below...</p>

<p><strong>BEANSTALK_CONNECT_TIMEOUT</strong> - Is used to set the time out on obtaining an initial
connection to a Beanstalk server. Defaults to 10 seconds and should be an integer value.</p>

<p><strong>BEANSTALK_DEFAULT_JOB_DELAY</strong> - Is used to set the default delay assigned to jobs added
to Beanstalk without an explicit delay. Default to zero and should be an integer value.</p>

<p><strong>BEANSTALK_DEFAULT_JOB_PRIORITY</strong> - Is used to set the default priority assigned to jobs
added to Beanstalk without an explicit priority. Defaults to 1000 and should be an integer
value.</p>

<p><strong>BEANSTALK_DEFAULT_JOB_TTR</strong> - Is used to set the default time to run assigned to jobs
added to Beanstsalk without an explicit TTR. Defaults to 3600 (1 hour) and should be an
integer value (in seconds).</p>

<p><strong>BEANSTALK_READ_BUFFER_SIZE</strong> - Is used to set the buffer sized for reading Beanstalk
messages from the server. Might be useful to bump in size if you're using very large
jobs but probably not. Should be an integer value.</p>

<h2><a id="development" class="anchor" href="#development">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Development</h2>

<p>Code is freely available, so familiarize yourself with that. Note that the unit tests
require an actual instance of Beanstalk to run and assume that they will be using an
instance on localhost at the default port number.</p>

<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>

<ol><li>Fork it (&lt;https://github.com/your-github-user/beanstalk-cr/fork>)</li><li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li><li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li><li>Push to the branch (<code>git push origin my-new-feature</code>)</li><li>Create a new Pull Request</li></ol>

<p>Pull requests will be reviewed as soon as is possible, though no timeline is
guaranteed. Ultimate decision on whether a PR gets merged or not remains my
perogative.</p>

<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>

<ul><li><a href="https://github.com/free-beer">Peter Wood</a> - creator and maintainer</li></ul>
</div>
</body>
</html>
